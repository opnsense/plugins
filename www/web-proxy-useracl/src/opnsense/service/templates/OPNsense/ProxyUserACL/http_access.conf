{% if helpers.exists('OPNsense.ProxyUserACL.general.ICAPs.ICAP') and helpers.exists('OPNsense.proxy.forward.icap.enable') and OPNsense.proxy.forward.icap.enable == '1' %}
{%      for priority in range(0,helpers.toList('OPNsense.ProxyUserACL.general.ICAPs.ICAP')|length) %}
{%          for ACL in helpers.toList('OPNsense.ProxyUserACL.general.ICAPs.ICAP') %}
{%              if ACL.Priority == priority|string %}
{%                  set access = [] %}
{%                  do access.append(ACL.Black) %}
{%                  if ACL.Users != null and helpers.exists('OPNsense.proxy.forward.authentication.method') %}
{%                      set auth = [] %}
{%                      set User = helpers.getUUID(ACL.Users) %}
{%                      for method in OPNsense.proxy.forward.authentication.method.split(",") %}
{%                          if method == User.Server %}
{%                              do auth.append("1") %}
{%                              do access.append(User.Group ~ "_" ~ User.id) %}
{%                          endif %}
{%                      endfor %}
{%                      if auth == [] %}
{%                          continue %}
{%                      endif %}
{%                  endif %}
{%                  if ACL.Domains != null %}
{%                      do access.append("domains_" ~ helpers.getUUID(ACL.Domains).id) %}
{%                  endif %}
{%                  if ACL.Agents != null %}
{%                      do access.append("agents_" ~ helpers.getUUID(ACL.Agents).id) %}
{%                  endif %}
{%                  if ACL.Times != null %}
{%                      do access.append("times_" ~ helpers.getUUID(ACL.Times).id) %}
{%                  endif %}
{%                  if ACL.Srcs != null %}
{%                      do access.append("srcs_" ~ helpers.getUUID(ACL.Srcs).id) %}
{%                  endif %}
{%                  if ACL.Dsts != null %}
{%                      do access.append("dsts_" ~ helpers.getUUID(ACL.Dsts).id) %}
{%                  endif %}
{%                  if ACL.Arps != null %}
{%                      do access.append("arps_" ~ helpers.getUUID(ACL.Arps).id) %}
{%                  endif %}
{%                  if ACL.Mimes != null %}
{%                      do access.append("mimes_req_" ~ helpers.getUUID(ACL.Mimes).id) %}
{%                  endif %}
adaptation_access response_mod {{ access|join(" ") }}
adaptation_access request_mod {{ access|join(" ") }}
{%              endif %}
{%          endfor %}
{%      endfor %}
{% endif %}


{% if helpers.exists('OPNsense.ProxyUserACL.general.HTTPAccesses.HTTPAccess') %}
{%      for priority in range(0,helpers.toList('OPNsense.ProxyUserACL.general.HTTPAccesses.HTTPAccess')|length) %}
{%          for ACL in helpers.toList('OPNsense.ProxyUserACL.general.HTTPAccesses.HTTPAccess') %}
{%              if ACL.Priority == priority|string %}
{%                  set access = [] %}
{%                  do access.append(ACL.Black) %}
{%                  if ACL.Users != null and helpers.exists('OPNsense.proxy.forward.authentication.method') %}
{%                      set auth = [] %}
{%                      set User = helpers.getUUID(ACL.Users) %}
{%                      for method in OPNsense.proxy.forward.authentication.method.split(",") %}
{%                          if method == User.Server %}
{%                              do auth.append("1") %}
{%                              do access.append(User.Group ~ "_" ~ User.id) %}
{%                          endif %}
{%                      endfor %}
{%                      if auth == [] %}
{%                          continue %}
{%                      endif %}
{%                  endif %}
{%                  if ACL.Domains != null %}
{%                      do access.append("domains_" ~ helpers.getUUID(ACL.Domains).id) %}
{%                  endif %}
{%                  if ACL.Agents != null %}
{%                      do access.append("agents_" ~ helpers.getUUID(ACL.Agents).id) %}
{%                  endif %}
{%                  if ACL.Times != null %}
{%                      do access.append("times_" ~ helpers.getUUID(ACL.Times).id) %}
{%                  endif %}
{%                  if ACL.Srcs != null %}
{%                      do access.append("srcs_" ~ helpers.getUUID(ACL.Srcs).id) %}
{%                  endif %}
{%                  if ACL.Dsts != null %}
{%                      do access.append("dsts_" ~ helpers.getUUID(ACL.Dsts).id) %}
{%                  endif %}
{%                  if ACL.Arps != null %}
{%                      do access.append("arps_" ~ helpers.getUUID(ACL.Arps).id) %}
{%                  endif %}
{%                  if ACL.Mimes != null %}
{%                      if helpers.exists('OPNsense.proxy.forward.icap.enable') and OPNsense.proxy.forward.icap.enable == '1' %}
adaptation_access response_mod mimes_rep_{{ helpers.getUUID(ACL.Mimes).id }} {{ access|join(" ") }}
adaptation_access request_mod mimes_rep_{{ helpers.getUUID(ACL.Mimes).id }} {{ access|join(" ") }}
{%                      endif %}
http_reply_access mimes_rep_{{ helpers.getUUID(ACL.Mimes).id }} {{ access|join(" ") }}
{%                      do access.append("mimes_req_" ~ helpers.getUUID(ACL.Mimes).id) %}
{%                  endif %}
{%                  if helpers.exists('OPNsense.proxy.forward.icap.enable') and OPNsense.proxy.forward.icap.enable == '1' %}
adaptation_access response_mod {{ access|join(" ") }}
adaptation_access request_mod {{ access|join(" ") }}
{%                  endif %}
http_access {{ access|join(" ") }}
{%              endif %}
{%          endfor %}
{%      endfor %}
{% endif %}
