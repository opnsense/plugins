{% if helpers.exists('OPNsense.ProxyUserACL.general.Domains.Domain') %}
{%      for Domain in helpers.toList('OPNsense.ProxyUserACL.general.Domains.Domain') %}
{%          set domains_list = [] %}
{%          for element in Domain.Names.split(",") %}
{%              if '^' in element or '\\' in element or '$' in element or '[' in element %}
{%                  do domains_list.append(element|encode_idna) %}
{%              else %}
{%                  do domains_list.append(element|encode_idna|replace(".","\.")) %}
{%              endif %}
{%          endfor %}
acl domains_{{Domain.id}} url_regex {{ domains_list|join(" ") }}
deny_info ERR_USERACL_DOMAIN_ACCESS_DENIED domains_{{ Domain.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Agents.Agent') %}
{%      for Agent in helpers.toList('OPNsense.ProxyUserACL.general.Agents.Agent') %}
{%          set agents_list = [] %}
{%          for element in Agent.Names.split(",") %}
{%              do agents_list.append(element) %}
{%          endfor %}
acl agents_{{Agent.id}} browser {{ agents_list|join(" ") }}
deny_info ERR_USERACL_AGENT_ACCESS_DENIED agents_{{ Agent.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Times.Time') %}
{%      for Time in helpers.toList('OPNsense.ProxyUserACL.general.Times.Time') %}
{%          set times_list = [] %}
{%          for element in Time.Names.split(",") %}
{%              do times_list.append(element) %}
{%          endfor %}
acl times_{{Time.id}} time {{ times_list|join(" ") }}
deny_info ERR_USERACL_TIME_ACCESS_DENIED times_{{ Time.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Mimes.Mime') %}
{%      for Mime in helpers.toList('OPNsense.ProxyUserACL.general.Mimes.Mime') %}
{%          set mimes_list = [] %}
{%          for element in Mime.Names.split(",") %}
{%              do mimes_list.append(element) %}
{%          endfor %}
acl mimes_req_{{Mime.id}} req_mime_type {{ mimes_list|join(" ") }}
acl mimes_rep_{{Mime.id}} rep_mime_type {{ mimes_list|join(" ") }}
deny_info ERR_USERACL_MIME_ACCESS_DENIED mimes_req_{{ Mime.id }}
deny_info ERR_USERACL_MIME_ACCESS_DENIED mimes_rep_{{ Mime.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Srcs.Src') %}
{%      for Src in helpers.toList('OPNsense.ProxyUserACL.general.Srcs.Src') %}
{%          set srcs_list = [] %}
{%          for element in Src.Names.split(",") %}
{%              do srcs_list.append(element) %}
{%          endfor %}
acl srcs_{{Src.id}} src {{ srcs_list|join(" ") }}
deny_info ERR_USERACL_SRC_ACCESS_DENIED srcs_{{ Src.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Dsts.Dst') %}
{%      for Dst in helpers.toList('OPNsense.ProxyUserACL.general.Dsts.Dst') %}
{%          set dsts_list = [] %}
{%          for element in Dst.Names.split(",") %}
{%              do dsts_list.append(element) %}
{%          endfor %}
acl dsts_{{Dst.id}} dst {{ dsts_list|join(" ") }}
deny_info ERR_USERACL_DST_ACCESS_DENIED dsts_{{ Dst.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Arps.Arp') %}
{%      for Arp in helpers.toList('OPNsense.ProxyUserACL.general.Arps.Arp') %}
{%          set arps_list = [] %}
{%          for element in Arp.Names.split(",") %}
{%              do arps_list.append(element) %}
{%          endfor %}
acl arps_{{Arp.id}} arp {{ arps_list|join(" ") }}
deny_info ERR_USERACL_ARP_ACCESS_DENIED arps_{{ Arp.id }}
{%      endfor %}
{% endif %}

{% if helpers.exists('OPNsense.ProxyUserACL.general.Users.User') and helpers.exists('OPNsense.proxy.forward.authentication.method') %}
{%      for User in helpers.toList('OPNsense.ProxyUserACL.general.Users.User') %}
{%          for method in OPNsense.proxy.forward.authentication.method.split(",") %}
{%              if method == User.Server %}
{%                  if method == "Local Database" %}
# {{method}}
{%                      if User.Group == "group" %}
external_acl_type ext_group_local_{{ User.id }} ttl=300 negative_ttl=60 %LOGIN /usr/local/libexec/squid/ext_unix_group_acl -p
acl group_{{User.id}} external ext_group_local_{{ User.id }} "/usr/local/etc/squid/ACL_useracl_{{ User.id }}.txt"
deny_info ERR_USERACL_ACCESS_DENIED group_{{User.id}}
{%                      else %}
acl user_{{User.id}} proxy_auth "/usr/local/etc/squid/ACL_useracl_{{ User.id }}.txt"
deny_info ERR_USERACL_ACCESS_DENIED user_{{User.id}}
{%                      endif%}
{%                  else %}
{%                      for server in helpers.toList('system.authserver') %}
{%                          if server.name == User.Server %}

# {{method}}
{%                              if server.type == 'ldap' %}
{%                                  if User.Group == "group" %}
{%                                      if helpers.exists('OPNsense.ProxySSO.EnableSSO') and OPNsense.ProxySSO.EnableSSO == '1' %}
external_acl_type ext_group_ldap_{{ User.id}} ttl=300 negative_ttl=60 %LOGIN /usr/local/libexec/squid/ext_kerberos_ldap_group_acl -a -t {{ User.Hex }} -D {{ system.domain|upper }}
acl group_{{User.id}} external ext_group_ldap_{{ User.id }}
deny_info ERR_USERACL_ACCESS_DENIED group_{{User.id}}
{%                                      else %}
{%                                          set containers = [] %}
{%                                          for authcn in server.ldap_authcn.split(";") %}
{%                                              do containers.append("(memberOf=cn=%a," ~ authcn ~ ")") %}
{%                                          endfor %}
{%                                          if server.ldap_attr_user == 'cn' %}
external_acl_type ext_ldap_{{ User.id }} ttl=300 negative_ttl=60 %LOGIN /usr/local/libexec/squid/ext_ldap_group_acl -R -b "{{server.ldap_basedn}}" -f "(&(cn=%a)(memberUid=%u))" -D "{{server.ldap_binddn}}" -w "{{server.ldap_bindpw}}" -p "{{server.ldap_port}}" "{{server.host}}"
{%                                          else %}
external_acl_type ext_ldap_{{ User.id }} ttl=300 negative_ttl=60 %LOGIN /usr/local/libexec/squid/ext_ldap_group_acl -R -b "{{server.ldap_basedn}}" -f "(&({{server.ldap_attr_user}}=%u)(|{{containers|join("")}}))" -D "{{server.ldap_binddn}}" -w "{{server.ldap_bindpw}}" -p "{{server.ldap_port}}" "{{server.host}}"
{%                                          endif %}
acl group_{{User.id}} external ext_ldap_{{ User.id }} "/usr/local/etc/squid/ACL_useracl_{{ User.id }}.txt"
deny_info ERR_USERACL_ACCESS_DENIED group_{{User.id}}
{%                                      endif %}
{%                                  else %}
acl user_{{User.id}} proxy_auth "/usr/local/etc/squid/ACL_useracl_{{ User.id }}.txt"
deny_info ERR_USERACL_ACCESS_DENIED user_{{User.id}}
{%                                  endif %}
{%                              endif %}
{%                          endif %}
{%                      endfor %}
{%                  endif %}
{%              endif %}
{%          endfor %}
{%      endfor %}
{% endif %}
