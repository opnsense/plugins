# DO NOT EDIT
# THIS FILE IS AUTOMATICALLY GENERATED - ANY CHANGES WILL BE OVERWRITTEN
#
{%  if not helpers.empty('OPNsense.tailscale.settings.enabled')  %}
tailscaled_enable="YES"
{%    if helpers.exists('OPNsense.tailscale.settings.disableSNAT') and OPNsense.tailscale.settings.disableSNAT|default("0") == "1" %}
# see - https://github.com/tailscale/tailscale/issues/5573#issuecomment-1584695981
tailscaled_env="TS_DEBUG_NETSTACK_SUBNETS=0"
{%    endif %}
{%    if helpers.exists('OPNsense.tailscale.settings.listenPort') %}
tailscaled_port="{{ OPNsense.tailscale.settings.listenPort }}"
{%    endif %}
{%    set up_args = [] %}
{%      do up_args.append("--timeout=" + OPNsense.tailscale.settings.loginTimeout + "s") %}
{%    if helpers.exists('OPNsense.tailscale.settings.advertiseExitNode') and OPNsense.tailscale.settings.advertiseExitNode|default("0") == "1" %}
{%      do up_args.append("--advertise-exit-node") %}
{%    else %}
{%      do up_args.append("--advertise-exit-node=false") %}
{%    endif %}
{%    if helpers.exists('OPNsense.tailscale.settings.useExitNode') %}
{%      do up_args.append("--exit-node=" + OPNsense.tailscale.settings.useExitNode) %}
{%    endif %}
{%    if helpers.exists('OPNsense.tailscale.settings.acceptSubnetRoutes') and OPNsense.tailscale.settings.acceptSubnetRoutes|default("0") == "1" %}
{%      do up_args.append("--accept-routes") %}
{%    else %}
{%      do up_args.append("--accept-routes=false") %}
{%    endif %}
{%    if helpers.exists('OPNsense.tailscale.settings.acceptDNS') and OPNsense.tailscale.settings.acceptDNS|default("0") == "1" %}
{%      do up_args.append("--accept-dns") %}
{%    else %}
{%      do up_args.append("--accept-dns=false") %}
{%    endif %}
{%    if helpers.exists('OPNsense.tailscale.settings.enableSSH') and OPNsense.tailscale.settings.enableSSH|default("0") == "1" %}
{%      do up_args.append("--ssh=true") %}
{%    else %}
{%      do up_args.append("--ssh=false") %}
{%    endif %}
{%    if helpers.exists('OPNsense.tailscale.authentication.loginServer') %}
{%      do up_args.append("--login-server=" + OPNsense.tailscale.authentication.loginServer) %}
{%    endif %}
{#    loop through subnets to build list #}
{%      if helpers.exists('OPNsense.tailscale.settings.subnets.subnet4') %}
{%        set subnets = [] %}
{%        for subnet_list in helpers.toList('OPNsense.tailscale.settings.subnets.subnet4') %}
{%          do subnets.append(subnet_list.subnet) %}
{%        endfor %}
{%        set subnetString = subnets|join(',') %}
{%        do up_args.append("--advertise-routes=" + subnetString) %}
{%      else %}
{%        do up_args.append("--advertise-routes=") %}
{%      endif %}
{%      if helpers.exists('OPNsense.tailscale.authentication.preAuthKey') %}
# Conditionally add auth-key only if not already authenticated
if [ -f /var/db/tailscale/tailscaled.state ] && grep -q '"_current-profile"' /var/db/tailscale/tailscaled.state 2>/dev/null; 
then
    tailscaled_up_args="{{ up_args|join(' ') }}"
else
    tailscaled_up_args="{{ up_args|join(' ') }} --auth-key={{ OPNsense.tailscale.authentication.preAuthKey }}"
fi
{%      else %}
tailscaled_up_args="{{ up_args|join(' ') }}"
{%      endif %}
{%  else %}
tailscaled_enable="NO"
{%  endif %}
