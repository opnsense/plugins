# DO NOT EDIT THIS FILE -- OPNsense auto-generated file

{% from 'OPNsense/Macros/interface.macro' import physical_interface %}
{%  set all_active_tables = [] %}
{% if helpers.exists('OPNsense.relayd.general') %}
{%  if helpers.exists('OPNsense.relayd.general.interval') %}
interval {{ OPNsense.relayd.general.interval }}
{%  endif %}
{%  if helpers.exists('OPNsense.relayd.general.log') %}
log state changes
{%    if OPNsense.relayd.general.log == 'all' %}
log host checks
{%    endif %}
{%  endif %}
{%  if helpers.exists('OPNsense.relayd.general.prefork') %}
prefork {{ OPNsense.relayd.general.prefork }}
{%  endif %}
{%  if helpers.exists('OPNsense.relayd.general.timeout') %}
timeout {{ OPNsense.relayd.general.timeout }}
{%  endif %}
{% endif %}

{% if helpers.exists('OPNsense.relayd.table') %}
{%  for table in helpers.toList('OPNsense.relayd.table') %}
{%   set disable = '' %}
{%   set hosts = [] %}
{%   if table.enabled|default('1') == '0' %}
{%    set disable = ' disable' %}
{%   endif %}
{%   for hostid in table.hosts.split(",") %}
{%     set host = helpers.getUUID(hostid) %}
{%     if host.enabled|default("1") == "1" %}
{%       do hosts.append(host) %}
{%     endif %}
{%   endfor %}
{%    if hosts|length > 0 %}
table <{{ table.name }}>{{ disable }} {
{%      do all_active_tables.append(table['@uuid']) %}
{%      for host in hosts %}
{%        set ipTTL = " ip ttl " ~ host.ipTTL if host.ipTTL is defined %}
{%        set priority = " priority " ~ host.priority if host.priority is defined %}
{%        set retry = " retry " ~ host.retry if host.retry is defined %}
{%        if host.enabled|default("1") == "1" %}
{{ host.address }}{{ ipTTL }}{{ priority }}{{ retry }}
{%        endif %}
{%      endfor %}
}
{%    endif %}
{%  endfor %}
{% endif %}

{% if helpers.exists('OPNsense.relayd.protocol') %}
{%  for protocol in helpers.toList('OPNsense.relayd.protocol') %}
{{ protocol.type }} protocol "{{protocol.name}}" {
   {{ protocol.options }}
}
{%  endfor %}
{% endif %}

{% if helpers.exists('OPNsense.relayd.virtualserver') %}
{%    for virtualserver in helpers.toList('OPNsense.relayd.virtualserver') %}
{%      if virtualserver.transport_table in all_active_tables or virtualserver.backuptransport_table in all_active_tables %}
{{ virtualserver.type }} "{{virtualserver.name}}" {
{%        if virtualserver.enabled|default('1') == '0' %}
disable
{%        endif %}
{%        set listen = "listen on " ~ virtualserver.listen_address %}
{%        if virtualserver.listen_proto is defined and virtualserver.type == 'redirect' %}
{%          set listen = listen ~ " " ~ virtualserver.listen_proto %}
{%        endif %}
{%        if virtualserver.listen_startport is defined %}
{%          set listen = listen ~ " port " ~ virtualserver.listen_startport %}
{%          if virtualserver.listen_endport is defined and virtualserver.type == 'redirect'%}
{%            set listen = listen ~ ":" ~ virtualserver.listen_endport %}
{%          endif %}
{%        endif %}
{%        if virtualserver.listen_interface is defined and virtualserver.type == 'redirect' %}
{%          set listen = listen ~ " interface " ~ physical_interface(virtualserver.listen_interface) %}
{%        endif %}
{{ listen }}
{%        set transport_type = 'forward' %}
{%        if virtualserver.type == 'redirect' %}
{%          set transport_type = virtualserver.transport_type %}
{%          if virtualserver.transport_type == 'route' %}
{%            set routing_interface = " interface " ~ virtualserver.routing_interface %}
{%          endif %}
{%        endif %}
{%        if virtualserver.transport_table in all_active_tables %}
{%          set table = helpers.getUUID(virtualserver.transport_table) %}
{%          set tablecheck = helpers.getUUID(virtualserver.transport_tablecheck) %}
{%          set _tablecheck = '' %}
{%          if tablecheck.type == 'http' and tablecheck.path is defined %}
{%            set _tablecheck = 'check ' ~ tablecheck.type %}
{%            if tablecheck.ssl|default('0') == '1' %}
{%              set _tablecheck = _tablecheck ~ 's' %}
{%            endif %}
{%            set _tablecheck = _tablecheck ~ ' "' ~ tablecheck.path ~ '"' %}
{%            if tablecheck.host is defined %}
{%              set _tablecheck = _tablecheck ~ ' host ' ~ tablecheck.host %}
{%            endif %}
{%            if tablecheck.code is defined %}
{%              set _tablecheck = _tablecheck ~ ' code ' ~ tablecheck.code %}
{%            elif tablecheck.digest is defined %}
{%              set _tablecheck = _tablecheck ~ ' digest "' ~ tablecheck.digest ~ '"' %}
{%            else %}
{%              set _tablecheck = '' %}
{%            endif %}
{%          elif tablecheck.type == 'script' and tablecheck.path is defined %}
{%            set _tablecheck = 'check ' ~ tablecheck.type ~ ' "' ~ tablecheck.path ~ '"' %}
{%          elif tablecheck.type == 'send' and tablecheck.expect is defined %}
{%            set _tablecheck = 'check ' ~ tablecheck.type ~ ' "' ~ tablecheck.data ~ '" expect "' ~ tablecheck.expect ~ '"' %}
{%            if tablecheck.ssl|default('0') == '1' %}
{%              set _tablecheck = _tablecheck ~ ' tls' %}
{%            endif %}
{%          else %}
{%            set _tablecheck = 'check ' ~ tablecheck.type %}
{%          endif %}
{%          set port = " port " ~ virtualserver.transport_port if virtualserver.transport_port is defined %}
{%          set timeout = " timeout " ~ virtualserver.transport_timeout if virtualserver.transport_timeout is defined %}
{%          set interval = " interval " ~ virtualserver.transport_interval if virtualserver.transport_interval is defined %}
{{ transport_type }} to <{{ table.name }}>{{ port }} mode {{ virtualserver.transport_tablemode }}{{ timeout }} {{ interval }} {{ _tablecheck }} {{ routing_interface }}
{%        endif %}
{%        set backuptablecheck = helpers.getUUID(virtualserver.backuptransport_tablecheck) if virtualserver.backuptransport_tablecheck is defined else None%}
{%        if backuptablecheck and virtualserver.backuptransport_table is defined and virtualserver.backuptransport_table in all_active_tables and virtualserver.transport_type == 'forward'  %}
{%          set backuptable = helpers.getUUID(virtualserver.backuptransport_table) %}
{%          set _backuptablecheck = '' %}
{%          if backuptablecheck.type == 'http' and backuptablecheck.path is defined%}
{%            set _backuptablecheck = 'check ' ~ backuptablecheck.type %}
{%            if backuptablecheck.ssl|default('0') == '1' %}
{%              set _backuptablecheck = _backuptablecheck ~ 's' %}
{%            endif %}
{%            set _backuptablecheck = _backuptablecheck ~ ' "' ~ backuptablecheck.path ~ '"' %}
{%            if backuptablecheck.host is defined %}
{%              set _backuptablecheck = _backuptablecheck ~ ' host ' ~ backuptablecheck.host %}
{%            endif %}
{%            if backuptablecheck.code is defined %}
{%              set _backuptablecheck = _backuptablecheck ~ ' code ' ~ backuptablecheck.code %}
{%            elif backuptablecheck.digest is defined %}
{%              set _backuptablecheck = _backuptablecheck ~ ' digest "' ~ backuptablecheck.digest ~ '"' %}
{%            else %}
{%              set _backuptablecheck = '' %}
{%            endif %}
{%          elif backuptablecheck.type == 'script' and backuptablecheck.path is defined %}
{%            set _backuptablecheck = 'check ' ~ backuptablecheck.type ~ ' "' ~ backuptablecheck.path ~ '"' %}
{%          elif backuptablecheck.type == 'send' and backuptablecheck.expect is defined %}
{%            set _backuptablecheck = 'check ' ~ backuptablecheck.type ~ ' "' ~ backuptablecheck.data ~ '" expect "' ~ backuptablecheck.expect ~ '"' %}
{%            if backuptablecheck.ssl|default('0') == '1' %}
{%              set _backuptablecheck = _backuptablecheck ~ ' tls' %}
{%            endif %}
{%          else %}
{%            set _backuptablecheck = 'check ' ~ backuptablecheck.type %}
{%          endif %}
{%          set backuptimeout = " timeout " ~ virtualserver.backuptransport_timeout if virtualserver.backuptransport_timeout is defined %}
{%          set backupinterval = " interval " ~ virtualserver.backuptransport_interval if virtualserver.backuptransport_interval is defined %}
{{ transport_type }} to <{{ backuptable.name }}>{{ port }} mode {{ virtualserver.transport_tablemode }}{{ backuptimeout }} {{ backupinterval }} {{ _backuptablecheck }}
{%        endif %}
{%        if virtualserver.sessiontimeout is defined %}
session timeout {{ virtualserver.sessiontimeout }}
{%        endif %}
{%        if virtualserver.stickyaddress|default('0') == '1' and virtualserver.type == 'redirect' %}
sticky-address
{%        endif %}
{%        if virtualserver.protocol is defined and virtualserver.type == 'relay' %}
{%          set protocol = helpers.getUUID(virtualserver.protocol) %}
protocol "{{ protocol.name }}"
{%        endif %}
}
{%      endif %}
{%    endfor %}
{% endif %}
