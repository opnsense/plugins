# DO NOT EDIT THIS FILE -- OPNsense auto-generated file

{% from 'OPNsense/Macros/interface.macro' import physical_interface %}
{% if helpers.exists('OPNsense.relayd.general') %}
{%  if helpers.exists('OPNsense.relayd.general.interval') %}
interval {{ OPNsense.relayd.general.interval }}
{%  endif %}
{%  if helpers.exists('OPNsense.relayd.general.log') %}
log {{ OPNsense.relayd.general.log }}
{%  endif %}
{%  if helpers.exists('OPNsense.relayd.general.prefork') %}
prefork {{ OPNsense.relayd.general.prefork }}
{%  endif %}
{%  if helpers.exists('OPNsense.relayd.general.timeout') %}
timeout {{ OPNsense.relayd.general.timeout }}
{%  endif %}
{% endif %}

{% if helpers.exists('OPNsense.relayd.table') %}
{%  for table in helpers.toList('OPNsense.relayd.table') %}
{%   set name = table.name %}
{%   set disable = '' %}
{%   set hosts = '' %}
{%   if table.enabled|default('1') == '0' %}
{%    set disable = ' disable' %}
{%   endif %}
table <{{ name }}>{{ disable }} {
{%    for host in table.hosts.split(",") %}
{%      set host = helpers.getUUID(host) %}
{%      set ipTTL = " ip ttl " ~ host.ipTTL if host.ipTTL is defined %}
{%      set priority = " priority " ~ host.priority if host.priority is defined %}
{%      set retry = " retry " ~ host.retry if host.retry is defined %}
{{ host.address }}{{ ipTTL }}{{ priority }}{{ retry }}
{%    endfor %}
}
{%  endfor %}
{% endif %}

{% if helpers.exists('OPNsense.relayd.protocol') %}
{%  for protocol in helpers.toList('OPNsense.relayd.protocol') %}
protocol "{{protocol.name}}" {
{{ protocol.type }} { {{ protocol.options }} }
}
{%  endfor %}
{% endif %}

{% if helpers.exists('OPNsense.relayd.virtualserver') %}
{%  for virtualserver in helpers.toList('OPNsense.relayd.virtualserver') %}
{{ virtualserver.type }} "{{virtualserver.name}}" {
{%   if virtualserver.enabled|default('1') == '0' %}
disable
{%   endif %}
{%   set listen = "listen on " ~ virtualserver.listen_address %}
{%   if virtualserver.listen_startport is defined %}
{%    set listen = listen ~ " port " ~ virtualserver.listen_startport %}
{%    if virtualserver.listen_endport is defined and virtualserver.type == 'redirect'%}
{%     set listen = listen ~ ":" ~ virtualserver.listen_endport %}
{%    endif %}
{%   endif %}
{%   if virtualserver.listen_interface is defined and virtualserver.type == 'redirect' %}
{%    set listen = listen ~ " interface " ~ physical_interface(virtualserver.listen_interface) %}
{%   endif %}
{{ listen }}
{%   set transport_type = 'forward' %}
{%   if virtualserver.type == 'redirect' %}
{%    set transport_type = virtualserver.transport_type %}
{%   endif %}
{%   set table = helpers.getUUID(virtualserver.transport_table) %}
{%   set tablecheck = helpers.getUUID(virtualserver.transport_tablecheck) %}
{%   set _tablecheck = '' %}
{%   if tablecheck.type == 'http' %}
{%    if tablecheck.path is defined %}
{%     if tablecheck.ssl|default('0') == '1' %}
{%      set _tablecheck = 'check ' ~ tablecheck.type ~ 's' %}
{%     endif %}
{%     set _tablecheck = _tablecheck ~ ' "' ~ tablecheck.path ~ '"' %}
{%     if tablecheck.host is defined %}
{%      set _tablecheck = _tablecheck ~ ' host ' ~ tablecheck.host %}
{%     endif %}
{%     if tablecheck.code is defined %}
{%      set _tablecheck = _tablecheck ~ ' code ' ~ tablecheck.code %}
{%     elif tablecheck.digest is defined %}
{%      set _tablecheck = _tablecheck ~ ' digest "' ~ tablecheck.digest ~ '"' %}
{%     else %}
{%      set _tablecheck = '' %}
{%     endif %}
{%    endif %}
{%   elif tablecheck.type == 'script' %}
{%    if tablecheck.path is defined %}
{%     set _tablecheck = 'check ' ~ tablecheck.type ~ ' "' ~ tablecheck.path ~ '"' %}
{%    endif %}
{%   elif tablecheck.type == 'send' %}
{%    if tablecheck.expect is defined %}
{%     set _tablecheck = 'check ' ~ tablecheck.type ~ ' "' ~ tablecheck.data ~ '" expect "' ~ tablecheck.expect ~ '"' %}
{%     if tablecheck.ssl|default('0') == '1' %}
{%      set _tablecheck = _tablecheck ~ ' ssl' %}
{%     endif %}
{%    endif %}
{%   else %}
{%    set _tablecheck = 'check ' ~ tablecheck.type %}
{%   endif %}
{%   set port = " port " ~ virtualserver.transport_port if virtualserver.transport_port is defined %}
{%   set timeout = " timeout " ~ virtualserver.transport_timeout if virtualserver.transport_timeout is defined %}
{%   set interval = " interval " ~ virtualserver.transport_interval if virtualserver.transport_interval is defined %}
{{ transport_type }} to <{{ table.name }}>{{ port }} mode {{ virtualserver.transport_tablemode }}{{ timeout }} {{ interval }} {{ _tablecheck }}
{%   if virtualserver.backuptransport_table is defined and virtualserver.transport_type == 'forward' %}
{%    set backuptable = helpers.getUUID(virtualserver.backuptransport_table) %}
{%    set backuptablecheck = helpers.getUUID(virtualserver.backuptransport_tablecheck) if virtualserver.backuptransport_tablecheck is defined %}
{%    set _backuptablecheck = '' %}
{%    if backuptablecheck.type == 'http' %}
{%     if backuptablecheck.path is defined %}
{%      if backuptablecheck.ssl|default('0') == '1' %}
{%       set _backuptablecheck = 'check ' ~ backuptablecheck.type ~ 's' %}
{%      endif %}
{%      set _backuptablecheck = _backuptablecheck ~ ' "' ~ backuptablecheck.path ~ '"' %}
{%      if backuptablecheck.host is defined %}
{%       set _backuptablecheck = _backuptablecheck ~ ' host ' ~ backuptablecheck.host %}
{%      endif %}
{%      if backuptablecheck.code is defined %}
{%       set _backuptablecheck = _backuptablecheck ~ ' code ' ~ backuptablecheck.code %}
{%      elif backuptablecheck.digest is defined %}
{%       set _backuptablecheck = _backuptablecheck ~ ' digest "' ~ backuptablecheck.digest ~ '"' %}
{%      else %}
{%       set _backuptablecheck = '' %}
{%      endif %}
{%     endif %}
{%    elif backuptablecheck.type == 'script' %}
{%     if backuptablecheck.path is defined %}
{%      set _backuptablecheck = 'check ' ~ backuptablecheck.type ~ ' "' ~ backuptablecheck.path ~ '"' %}
{%     endif %}
{%    elif backuptablecheck.type == 'send' %}
{%     if backuptablecheck.expect is defined %}
{%      set _backuptablecheck = 'check ' ~ backuptablecheck.type ~ ' "' ~ backuptablecheck.data ~ '" expect "' ~ backuptablecheck.expect ~ '"' %}
{%      if backuptablecheck.ssl|default('0') == '1' %}
{%       set _backuptablecheck = _backuptablecheck ~ ' ssl' %}
{%      endif %}
{%     endif %}
{%    else %}
{%     set _backuptablecheck = 'check ' ~ backuptablecheck.type %}
{%    endif %}
{%   set backuptimeout = " timeout " ~ virtualserver.backuptransport_timeout if virtualserver.backuptransport_timeout is defined %}
{%   set backupinterval = " interval " ~ virtualserver.backuptransport_interval if virtualserver.backuptransport_interval is defined %}
{{ transport_type }} to <{{ backuptable.name }}>{{ port }} mode {{ virtualserver.transport_tablemode }}{{ backuptimeout }} {{ backupinterval }} {{ _backuptablecheck }}
{%   endif %}
{%   if virtualserver.sessiontimeout is defined %}
session timeout {{ virtualserver.sessiontimeout }}
{%   endif %}
{%   if virtualserver.stickyaddress|default('0') == '1' and virtualserver.type == 'redirect' %}
sticky-address
{%   endif %}
{%   if virtualserver.protocol is defined and virtualserver.type == 'relay' %}
{%    set protocol = helpers.getUUID(virtualserver.protocol) %}
protocol "{{ protocol.name }}"
{%   endif %}
}
{%  endfor %}
{% endif %}
