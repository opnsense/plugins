include       mime.types;
default_type  application/octet-stream;

log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

sendfile        on;
#tcp_nopush     on;

#keepalive_timeout  0;
keepalive_timeout  65;

gzip  on;
server_tokens off;
#add_header X-Frame-Options SAMEORIGIN;
#add_header X-Content-Type-Options nosniff;
#add_header X-XSS-Protection "1; mode=block";
#add_header Referrer-Policy "same-origin";
    
# UPSTREAM SERVERS
# TODO create upstream bracket
{% for upstream in helpers.toList('OPNsense.Nginx.upstream') %}
{%   for upstream_serveruuid in upstream.serverentries.split(',') %}
upstream @asdf {
{%     set upstream_server = helpers.getUUID(upstream_serveruuid) %}
server {% if ':' in upstream_server.server %}[{% endif %}{{ upstream_server.server }}{% if ':' in upstream_server.server %}]{% endif 
       %}{% if upstream_server.port is defined %}:{{ upstream_server.port }}{% endif
       %}{% if upstream_server.priority is defined %} weight={{ upstream_server.priority }}{% endif
       %}{% if upstream_server.max_conns is defined %} max_conns={{ upstream_server.max_conns }}{% endif
       %}{% if upstream_server.max_fails is defined %} max_fails={{ upstream_server.max_fails }}{% endif
       %}{% if upstream_server.fail_timeout is defined %} fail_timeout={{ upstream_server.fail_timeout }}{% endif
       %}{% if upstream_server.no_use is defined %} {{ upstream_server.no_use }}{% endif %};
{%   endfor %}

}
{% endfor %}

{% for server in helpers.toList('OPNsense.Nginx.http_server') %}
{%   set single_servername = server.servername.split(",")[0] %}
server {
{%   if server.listen_http_port is defined %}
    listen  [::]:{{ server.listen_http_port }} ipv6only=off http2;
{%   endif %}
{%   if server.listen_https_port is defined %}
    listen  [::]:{{ server.listen_https_port }} ipv6only=off http2 ssl;
    ssl_verify_client {{ server.verify_client }};
    ssl_certificate_key /etc/nginx/key/{{ single_servername }}.pem;
    ssl_certificate /etc/nginx/key/{{ single_servername }}.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_dhparam /etc/nginx/key/dhparam.pem;
    ssl_ciphers 'ECDHE-ECDSA-CAMELLIA256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CAMELLIA256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CAMELLIA128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CAMELLIA128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-CAMELLIA256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-CAMELLIA256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-ECDSA-CAMELLIA128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    proxy_set_header X-TLS-Cipher $ssl_cipher;
    proxy_set_header X-TLS-Protocol $ssl_protocol;
    proxy_set_header X-TLS-SNI-Host $ssl_server_name;
{%   endif %}
    # proxy headers for backend server
{% if server.verify_client != 'off' %}
    proxy_set_header X-Client-Dn $ssl_client_s_dn;
    proxy_set_header X-Client-Verify $ssl_client_verify;
{% endif %}
{% if server.verify_client == 'optional_no_ca' %}
    proxy_set_header X-Client-Certificate $ssl_client_escaped_cert;
{% endif %}
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    server_name  {{ server.servername }};
    charset {{ server.charset }};
    access_log  /var/log/nginx/{{ server.servername }}.access.log {{ server.access_log_format }};
    #include tls.conf;
    error_page 404 /opnsense_error_404.html;
    error_page 500 501 502 503 504 /opnsense_server_error.html;
    # location to ban the host permanently
    location @permanentban {
        access_log /var/log/nginx/hacking.access.log combined;
        internal;
        add_header Content-Type text/plain;
        add_header Charset utf-8;
        return 403 "You got banned permanently from this server.";
    }
    location /opnsense_server_error.html {
        internal;
        root /usr/local/etc/nginx/views;
    }
    location /opnsense_error_404.html {
        internal;
        root /usr/local/etc/nginx/views;
    }
    # block based on User Agents - stuff I have found over the years in my server log
    if ($http_user_agent ~* Python-urllib|Nmap|python-requests|libwww-perl|MJ12bot|Jorgee|fasthttp) {
      error_page 403 = @permanentban;
      return 403;
    }
    if ($http_user_agent ~ "Indy\sLibrary")
    {
      error_page 403 = @permanentban;
      return 403;
    }
{%   if server.block_nonpublic_data is defined and server.block_nonpublic_data == '1' %}
    # apache htpasswd and htaccess
    location ~ /\.ht {
        deny  all;
    }
    # those files may expose file system stuff
    location ~ \.DS_Store$ {
        return 403;
    }
{%   endif %}

{%   if server.locations is defined %}
{%     for location_uuid in server.locations.split(',') %}
{%       set location = helpers.getUUID(location_uuid) %}
{%       include "OPNsense/Nginx/location.conf" ignore missing with context %}
{%     endfor %}
{%   endif %}

}

{% endfor %}
