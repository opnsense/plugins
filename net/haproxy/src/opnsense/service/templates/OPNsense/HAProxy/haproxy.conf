#
# Automatically generated configuration.
# Do not edit this file manually.
{% if helpers.exists('OPNsense.HAProxy') %}

{# ############################### #}
{#             MACROS              #}
{# ############################### #}

{# Macro expects a CSV list of Error Files and validates them. #}
{% macro ErrorFiles(linkedData) -%}
{%   if linkedData is defined %}
{#     # remember all Errorfiles to avoid duplicate HTTP codes #}
{%     set http_codes_seen = [] %}
{%     for errorfile in linkedData.split(",") %}
{%       set errorfile_data = helpers.getUUID(errorfile) %}
{%       if errorfile_data.code in http_codes_seen %}
    # ERROR FILE INVALID: {{errorfile_data.name}}
    # ERROR: this HTTP code is already used by another error file in this context
{%       else %}
{%         do http_codes_seen.append(errorfile_data.code) %}
    # ERROR FILE: {{errorfile_data.name}}
    errorfile {{errorfile_data.code|replace("x", "")}} /var/etc/haproxy/errorfiles/{{errorfile_data.id}}.txt
{%       endif %}
{%     endfor %}
{%   else %}
# ERROR: ErrorFiles called with empty data
{%   endif %}
{%- endmacro %}

{# Macro expects a CSV list of Actions and validates them. #}
{% macro AclsAndActions(linkedData) -%}
{%   if linkedData is defined %}
{#     # remember all ACLs to avoid duplicate declarations #}
{%     set acls_seen = [] %}
{%     for action in linkedData.split(",") %}
{%       set action_data = helpers.getUUID(action) %}
{#       # collect ACLs for this action #}
{%       set action_acls = [] %}
{#       # collect ACL errors (may disable Action) #}
{%       set acl_errors = 0 %}
{#       # An action with no ACLs may still be valid #}
{%       if action_data.linkedAcls|default("") != "" %}
{%         for acl in action_data.linkedAcls.split(",") %}
{%           set acl_enabled = '1' %}
{%           set acl_data = helpers.getUUID(acl) %}
{#           # check if this ACL can be found in configuration #}
{%           if acl_data == {} %}
    # ERROR: ACL data not found ({{acl}})
{%             set acl_errors = acl_errors + 1 %}
{%             set acl_enabled = '0' %}
{%           else %}
{#             # first check if this ACL condition should be negated #}
{%             if acl_data.negate|default("") == '1' %}
{%               do action_acls.append('!acl_' ~ acl_data.id) if acl_data.negate|default("") == '1' %}
{%             else %}
{%               do action_acls.append('acl_' ~ acl_data.id) %}
{%             endif %}
{#             # check if this ACL was already defined in this scope #}
{%             if acl_data.id in acls_seen %}
{#  # DEBUG: ignoring duplicate ACL {{acl_data.name}} #}
{%               continue %}
{%             endif %}
{%             do acls_seen.append(acl_data.id) %}
{%             set acl_options = [] %}
{%             if acl_data.expression == 'hdr_beg' %}
{%               if acl_data.hdr_beg|default("") != "" %}
{%                 do acl_options.append('hdr_beg(host) -i ' ~ acl_data.hdr_beg) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'hdr_end' %}
{%               if acl_data.hdr_end|default("") != "" %}
{%                 do acl_options.append('hdr_end(host) -i ' ~ acl_data.hdr_end) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'hdr' %}
{%               if acl_data.hdr|default("") != "" %}
{%                 do acl_options.append('hdr(host) -i ' ~ acl_data.hdr) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'hdr_reg' %}
{%               if acl_data.hdr_reg|default("") != "" %}
{%                 do acl_options.append('hdr_reg(host) -i ' ~ acl_data.hdr_reg) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'hdr_sub' %}
{%               if acl_data.hdr_sub|default("") != "" %}
{%                 do acl_options.append('hdr_sub(host) -i ' ~ acl_data.hdr_sub) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'path_beg' %}
{%               if acl_data.path_beg|default("") != "" %}
{%                 do acl_options.append('path_beg -i ' ~ acl_data.path_beg) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'path_end' %}
{%               if acl_data.path_end|default("") != "" %}
{%                 do acl_options.append('path_end -i ' ~ acl_data.path_end) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'path' %}
{%               if acl_data.path|default("") != "" %}
{%                 do acl_options.append('path -i ' ~ acl_data.path) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'path_reg' %}
{%               if acl_data.path_reg|default("") != "" %}
{%                 do acl_options.append('path_reg -i ' ~ acl_data.path_reg) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'path_dir' %}
{%               if acl_data.path_dur|default("") != "" %}
{%                 do acl_options.append('path_dir -i ' ~ acl_data.path_dir) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'path_sub' %}
{%               if acl_data.path_sub|default("") != "" %}
{%                 do acl_options.append('path_sub -i ' ~ acl_data.path_sub) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'url_param' %}
{%               if acl_data.url_param_value|default("") != "" and acl_data.url_param|default("") != "" %}
{%                 do acl_options.append('url_param(' ~ acl_data.url_param ~ ') -i ' ~ acl_data.url_param_value) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_c_verify_code' %}
{%               if acl_data.ssl_c_verify_code|default("") != "" %}
{%                 do acl_options.append('ssl_c_verify ' ~ acl_data.ssl_c_verify_code) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_c_verify' %}
{%               do acl_options.append('ssl_c_verify 0') %}
{%             elif acl_data.expression == 'ssl_c_ca_commonname' %}
{%               if acl_data.ssl_c_ca_commonname|default("") != "" %}
{%                 do acl_options.append('ssl_c_i_dn(CN) ' ~ acl_data.ssl_c_ca_commonname) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_fc' %}
{%               do acl_options.append('ssl_fc') %}
{%             elif acl_data.expression == 'src' %}
{%               if acl_data.src|default("") != "" %}
{%                 do acl_options.append('src ' ~ acl_data.src) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'nbsrv' %}
{%               do acl_options.append('') %}
{%               if acl_data.nbsrv|default("") != "" %}
{%                 if acl_data.nbsrv_backend|default("") != "" %}
{%                   do acl_options.append('nbsrv(backend_' ~ acl_data.nbsrv_backend ~ ') ge ' ~ acl_data.nbsrv) %}
{%                 else %}
{%                   do acl_options.append('nbsrv ge ' ~ acl_data.nbsrv) %}
{%                 endif %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'traffic_is_http' %}
{%               do acl_options.append('req.proto_http') %}
{%             elif acl_data.expression == 'traffic_is_ssl' %}
{%               do acl_options.append('req.ssl_ver gt 0') %}
{%             elif acl_data.expression == 'ssl_sni' %}
{%               if acl_data.ssl_sni|default("") != "" %}
{%                 do acl_options.append('req.ssl_sni -i ' ~ acl_data.ssl_sni) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_sni_sub' %}
{%               if acl_data.ssl_sni_sub|default("") != "" %}
{%                 do acl_options.append('req.ssl_sni -m sub -i ' ~ acl_data.ssl_sni_sub) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_sni_beg' %}
{%               if acl_data.ssl_sni_beg|default("") != "" %}
{%                 do acl_options.append('req.ssl_sni -m beg -i ' ~ acl_data.ssl_sni_beg) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_sni_end' %}
{%               if acl_data.ssl_sni_end|default("") != "" %}
{%                 do acl_options.append('req.ssl_sni -m end -i ' ~ acl_data.ssl_sni_end) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'ssl_sni_reg' %}
{%               if acl_data.ssl_sni_reg|default("") != "" %}
{%                 do acl_options.append('req.ssl_sni -m reg -i ' ~ acl_data.ssl_sni_reg) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             elif acl_data.expression == 'custom_acl' %}
{%               if acl_data.custom_acl|default("") != "" %}
{%                 do acl_options.append(acl_data.custom_acl) %}
{%               else %}
{%                 set acl_enabled = '0' %}
    # ERROR: missing parameters
{%               endif %}
{%             else %}
{%               set acl_enabled = '0' %}
    # ERROR: unsupported ACL expression
{%             endif %}
{%           endif %}
{#           # check if ACL is valid #}
{%           if acl_enabled == '1' %}
    # ACL: {{acl_data.name}}
    acl acl_{{acl_data.id}} {{acl_options|join(' ')}}
{%           else %}
{%             set acl_errors = acl_errors + 1 %}
    # ACL INVALID: {{acl_data.name}} ({{acl}})
{%           endif %}
{%         endfor %}
{%       endif %}
{#       # NOTE: We're ignoring actions if any ACL is erroneous, #}
{#       #       because doing otherwise would lead to unpredictable behaviour. #}
{%       if acl_errors|int == 0 %}
{%         set action_enabled = '1' %}
{%         set action_options = [] %}
{%         if action_data.type == 'use_backend' %}
{%           if action_data.use_backend|default("") != "" %}
{%             set acl_backend_data = helpers.getUUID(action_data.use_backend) %}
{%             do action_options.append('use_backend ' ~ acl_backend_data.name) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'use_server' %}
{%           if action_data.use_server|default("") != "" %}
{%             set server_data = helpers.getUUID(action_data.use_server) %}
{%             do action_options.append('use-server ' ~ server_data.name) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_allow' %}
{%           do action_options.append('http-request allow') %}
{%         elif action_data.type == 'http-request_deny' %}
{%           do action_options.append('http-request deny') %}
{%         elif action_data.type == 'http-request_tarpit' %}
{%           do action_options.append('http-request tarpit') %}
{%         elif action_data.type == 'http-request_auth' %}
{%           if action_data.http_request_auth|default("") != "" %}
{%             do action_options.append('http-request auth realm ' ~ action_data.http_request_auth) %}
{%           else %}
{%             do action_options.append('http-request auth') %}
{%           endif %}
{%         elif action_data.type == 'http-request_redirect' %}
{%           if action_data.http_request_redirect|default("") != "" %}
{%             do action_options.append('http-request redirect ' ~ action_data.http_request_redirect) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_lua' %}
{%           if action_data.http_request_lua|default("") != "" %}
{%             do action_options.append('http-request lua.' ~ action_data.http_request_lua) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_use-service' %}
{%           if action_data.http_request_use_service|default("") != "" %}
{%             do action_options.append('http-request use-service lua.' ~ action_data.http_request_use_service) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_add-header' %}
{%           if action_data.http_request_add_header_name|default("") != "" and action_data.http_request_add_header_content|default("") != "" %}
{%             do action_options.append('http-request add-header ' ~ action_data.http_request_add_header_name ~ ' ' ~ action_data.http_request_add_header_content) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_set-header' %}
{%           if action_data.http_request_set_header_name|default("") != "" and action_data.http_request_set_header_content|default("") != "" %}
{%             do action_options.append('http-request set-header ' ~ action_data.http_request_set_header_name ~ ' ' ~ action_data.http_request_set_header_content) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_del-header' %}
{%           if action_data.http_request_del_header_name|default("") != "" %}
{%             do action_options.append('http-request del-header' ~ action_data.http_request_del_header_name) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_replace-header' %}
{%           if action_data.http_request_replace_header_name|default("") != "" and action_data.http_request_replace_header_regex|default("") != "" %}
{%             do action_options.append('http-request replace-header ' ~ action_data.http_request_replace_header_name ~ ' ' ~ action_data.http_request_replace_header_regex) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-request_replace-value' %}
{%           if action_data.http_request_replace_value_name|default("") != "" and action_data.http_request_replace_value_regex|default("") != "" %}
{%             do action_options.append('http-request replace-value ' ~ action_data.http_request_replace_value_name ~ ' ' ~ action_data.http_request_replace_value_regex) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-response_allow' %}
{%           do action_options.append('http-response allow') %}
{%         elif action_data.type == 'http-response_deny' %}
{%           do action_options.append('http-response deny') %}
{%         elif action_data.type == 'http-response_lua' %}
{%           if action_data.http_response_lua|default("") != "" %}
{%             do action_options.append('http-response lua.' ~ action_data.http_response_lua) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-response_add-header' %}
{%           if action_data.http_response_add_header_name|default("") != "" and action_data.http_response_add_header_content|default("") != "" %}
{%             do action_options.append('http-response add-header ' ~ action_data.http_response_add_header_name ~ ' ' ~ action_data.http_response_add_header_content) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-response_set-header' %}
{%           if action_data.http_response_set_header_name|default("") != "" and action_data.http_response_set_header_content|default("") != "" %}
{%             do action_options.append('http-response set-header ' ~ action_data.http_response_set_header_name ~ ' ' ~ action_data.http_response_set_header_content) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-response_del-header' %}
{%           if action_data.http_response_del_header_name|default("") != "" %}
{%             do action_options.append('http-response del-header' ~ action_data.http_response_del_header_name) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-response_replace-header' %}
{%           if action_data.http_response_replace_header_name|default("") != "" and action_data.http_response_replace_header_regex|default("") != "" %}
{%             do action_options.append('http-response replace-header ' ~ action_data.http_response_replace_header_name ~ ' ' ~ action_data.http_response_replace_header_regex) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'http-response_replace-value' %}
{%           if action_data.http_response_replace_value_name|default("") != "" and action_data.http_response_replace_value_regex|default("") != "" %}
{%             do action_options.append('http-response replace-value ' ~ action_data.http_response_replace_value_name ~ ' ' ~ action_data.http_response_replace_value_regex) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'tcp-request_connection_accept' %}
{%           do action_options.append('tcp-request connection accept') %}
{%         elif action_data.type == 'tcp-request_connection_reject' %}
{%           do action_options.append('tcp-request connection reject') %}
{%         elif action_data.type == 'tcp-request_content_accept' %}
{%           do action_options.append('tcp-request content accept') %}
{%         elif action_data.type == 'tcp-request_content_reject' %}
{%           do action_options.append('tcp-request content reject') %}
{%         elif action_data.type == 'tcp-request_content_lua' %}
{%           if action_data.tcp-request_content_lua|default("") != "" %}
{%             do action_options.append('tcp-request content lua.' ~ action_data.tcp_request_content_lua) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'tcp-request_content_use-service' %}
{%           if action_data.tcp_request_content_use_service|default("") != "" %}
{%             do action_options.append('tcp-request content use-service lua.' ~ action_data.tcp_request_content_use_service) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'tcp-response_content_accept' %}
{%           do action_options.append('tcp-response content accept') %}
{%         elif action_data.type == 'tcp-response_content_close' %}
{%           do action_options.append('tcp-response content close') %}
{%         elif action_data.type == 'tcp-response_content_reject' %}
{%           do action_options.append('tcp-response content reject') %}
{%         elif action_data.type == 'tcp-response_content_lua' %}
{%           if action_data.tcp_response_content_lua|default("") != "" %}
{%             do action_options.append('tcp-response content lua.' ~ action_data.tcp_response_content_lua) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         elif action_data.type == 'custom' %}
{%           if action_data.custom|default("") != "" %}
{%             do action_options.append(action_data.custom) %}
{%           else %}
{%             set action_enabled = '0' %}
    # ERROR: missing parameters
{%           endif %}
{%         else %}
{%           set action_enabled = '0' %}
    # ERROR: unsupported action type
{%         endif %}
{#         # check if action is valid #}
{%         if action_enabled == '1' %}
{%           if action_data.operator == 'or' %}
{%             set join_operator = ' || ' %}
{%           else %}
{%             set join_operator = ' ' %}
{%           endif %}
{#           # check if action depends on ACLs #}
{%           if action_acls|length > 0 %}
    # ACTION: {{action_data.name}}
    {{action_options|join(' ')}} {{action_data.testType}} {{action_acls|join(join_operator)}}
{%           else %}
    # NOTE: actions with no ACLs/conditions will always match
    # ACTION: {{action_data.name}}
    {{action_options|join(' ')}}
{%           endif %}
{%         else %}
    # ACTION INVALID: {{action_data.name}}
{%         endif %}
{%       else %}
    # ACTION INVALID: {{action_data.name}}
    # ACL ERROR COUNT: {{acl_errors}}
{%       endif %}
{%     endfor %}
{%   else %}
# ERROR: AclsAndActions called with empty data
{%   endif %}
{%- endmacro %}

{% if not (helpers.exists('OPNsense.HAProxy.general') and OPNsense.HAProxy.general.enabled|default("0") == "1") %}
#
# NOTE: HAProxy is currently DISABLED
#
{% endif %}

{# ############################### #}
{#             GLOBAL              #}
{# ############################### #}

global
{% if OPNsense.HAProxy.general.tuning.root != "1" %}
    # NOTE: Could be a security issue, but required for some feature.
    uid                         80
{% endif %}
    gid                         80
    chroot                      /var/haproxy
    daemon
    stats                       socket /var/run/haproxy.socket level admin
    nbproc                      {{OPNsense.HAProxy.general.tuning.nbproc}}
{% if helpers.exists('OPNsense.HAProxy.general.tuning.maxConnections') %}
    maxconn                     {{OPNsense.HAProxy.general.tuning.maxConnections}}
{% endif %}
{% if helpers.exists('OPNsense.HAProxy.general.tuning.maxDHSize') %}
    tune.ssl.default-dh-param   {{OPNsense.HAProxy.general.tuning.maxDHSize}}
{% endif %}
{% if helpers.exists('OPNsense.HAProxy.general.tuning.sslServerVerify') %}
{%     if OPNsense.HAProxy.general.tuning.sslServerVerify|default("") != 'ignore' %}
    ssl-server-verify           {{OPNsense.HAProxy.general.tuning.sslServerVerify}}
{%     endif %}
{% endif %}
{% if OPNsense.HAProxy.general.tuning.spreadChecks|default("") != "" %}
    spread-checks               {{OPNsense.HAProxy.general.tuning.spreadChecks}}
{% endif %}
{% if OPNsense.HAProxy.general.tuning.checkBufferSize|default("") != "" %}
    tune.chksize                {{OPNsense.HAProxy.general.tuning.checkBufferSize}}
{% endif %}
{% if OPNsense.HAProxy.general.tuning.bufferSize|default("") != "" %}
    tune.bufsize                {{OPNsense.HAProxy.general.tuning.bufferSize}}
{% endif %}
{% if OPNsense.HAProxy.general.tuning.luaMaxMem|default("") != "" %}
    tune.lua.maxmem             {{OPNsense.HAProxy.general.tuning.luaMaxMem}}
{% endif %}
{# # logging configuration #}
{% set logging = [] %}
{% if OPNsense.HAProxy.general.logging.host != '127.0.0.1' %}
{%   do logging.append(OPNsense.HAProxy.general.logging.host) %}
{% else %}
{%   do logging.append('/var/run/log') %}
{% endif %}
{% do logging.append('len ' ~ OPNsense.HAProxy.general.logging.length) if OPNsense.HAProxy.general.logging.length|default("") != "" %}
{% do logging.append(OPNsense.HAProxy.general.logging.facility) %}
{% do logging.append(OPNsense.HAProxy.general.logging.level) if OPNsense.HAProxy.general.logging.level|default("") != "" %}
    log {{logging|join(' ')}}
{% if helpers.exists('OPNsense.HAProxy.luas.lua') %}
    # lua scripts
{%   for lua in helpers.toList('OPNsense.HAProxy.luas.lua') %}
{%     if lua.enabled == '1' %}
    # lua script: {{lua.name}}
    lua-load /var/etc/haproxy/lua/{{lua.id}}.lua
{%     endif %}
{%   endfor %}
{% endif %}
{# # ssl default settings #}
{% if OPNsense.HAProxy.general.tuning.ssl_defaultsEnabled|default("") == '1' %}
{%   if OPNsense.HAProxy.general.tuning.ssl_bindOptions|default("") != "" %}
{%     set bindopts = [] %}
{%     for bindopt in OPNsense.HAProxy.general.tuning.ssl_bindOptions.split(",") %}
{%       do bindopts.append(bindopt) %}
{%     endfor %}
    ssl-default-bind-options {{ bindopts|join(' ') }}
{%   endif %}
{%   if OPNsense.HAProxy.general.tuning.ssl_cipherList|default("") != "" %}
    ssl-default-bind-ciphers {{ OPNsense.HAProxy.general.tuning.ssl_cipherList }}
{%   endif %}
{% endif %}
{# # pass-through options #}
{% if OPNsense.HAProxy.general.tuning.customOptions|default("") != "" %}
    # WARNING: pass through options below this line
{%   for customOpt in OPNsense.HAProxy.general.tuning.customOptions.split("\n") %}
    {{customOpt}}
{%   endfor %}
{% endif %}

{# ############################### #}
{#             DEFAULTS            #}
{# ############################### #}

{% if helpers.exists('OPNsense.HAProxy.general.defaults') %}
defaults
    log     global
{%   if OPNsense.HAProxy.general.defaults.redispatch|default("") != "" %}
    option redispatch {{OPNsense.HAProxy.general.defaults.redispatch|replace("x", "")}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.maxConnections|default("") != "" %}
    maxconn {{OPNsense.HAProxy.general.defaults.maxConnections}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.timeoutClient|default("") != "" %}
    timeout client {{OPNsense.HAProxy.general.defaults.timeoutClient}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.timeoutConnect|default("") != "" %}
    timeout connect {{OPNsense.HAProxy.general.defaults.timeoutConnect}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.timeoutCheck|default("") != "" %}
    timeout check {{OPNsense.HAProxy.general.defaults.timeoutCheck}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.timeoutServer|default("") != "" %}
    timeout server {{OPNsense.HAProxy.general.defaults.timeoutServer}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.retries|default("") != "" %}
    retries {{OPNsense.HAProxy.general.defaults.retries}}
{%   endif %}
{%   if OPNsense.HAProxy.general.defaults.customOptions|default("") != "" %}
    # WARNING: pass through options below this line
{%     for customOpt in OPNsense.HAProxy.general.defaults.customOptions.split("\n") %}
    {{customOpt}}
{%     endfor %}
{%   endif %}
{% endif %}

{# ############################### #}
{#             FRONTENDS           #}
{# ############################### #}

{% if helpers.exists('OPNsense.HAProxy.frontends') %}
{%   for frontend in helpers.toList('OPNsense.HAProxy.frontends.frontend') %}
{%     if frontend.enabled == '1' %}
# Frontend: {{frontend.name}} ({{frontend.description}})
frontend {{frontend.name}}
{%       set ssl_certs = [] %}
{%       set ssl_options = [] %}
{%       if frontend.ssl_enabled == '1' %}
{#         # check if ssl certs are configured #}
{%         if frontend.ssl_certificates|default("") != "" %}
{#           # NOTE: Cert lists are generated by exportCerts.php #}
{%           do ssl_certs.append('crt-list /var/etc/haproxy/ssl/' ~ frontend.id ~ '.crtlist') %}
{%         endif %}
{#         # advanced ssl parameters (pass-through) #}
{%         if frontend.ssl_customOptions|default("") != "" %}
{%           do ssl_options.append(frontend.ssl_customOptions ~ ' ') %}
{%         endif %}
{#         # advanced ssl settings #}
{%         if frontend.ssl_advancedEnabled|default("") == '1' %}
{%           if frontend.ssl_bindOptions|default("") != "" %}
{%             for bindopt in frontend.ssl_bindOptions.split(",") %}
{%               do ssl_options.append(bindopt) %}
{%             endfor %}
{%           endif %}
{%           if frontend.ssl_cipherList|default("") != "" %}
{%             do ssl_options.append('ciphers ' ~ frontend.ssl_cipherList) %}
{%           endif %}
{#           # HSTS #}
{%           if frontend.ssl_hstsEnabled|default("") == '1' %}
    http-response set-header Strict-Transport-Security max-age={{frontend.ssl_hstsMaxAge}}
{%           endif %}
{%         endif %}
{%       endif %}
{#       # bind/listen configuration #}
{%       if frontend.bind|default("") != "" %}
{%         for bind in frontend.bind.split(",") %}
    bind {{bind}} name {{bind}} {% if frontend.bindOptions|default("") != "" %}{{ frontend.bindOptions }} {% endif %}{% if frontend.ssl_enabled == '1' and ssl_certs|default("") != "" %}ssl {{ ssl_options|join(' ') }} {{ ssl_certs|join(' ') }} {% endif %}

{%         endfor %}
{%       endif %}
{%       if frontend.mode == "ssl" %}
    mode tcp
{%       else %}
    mode {{frontend.mode}}
{%       endif %}
{%       if frontend.mode != "tcp" and frontend.mode != "ssl" %}
    option {{frontend.connectionBehaviour}}
{%       endif %}
{#       # select backend #}
{%       if frontend.defaultBackend|default("") != "" %}
{%         set backend_data = helpers.getUUID(frontend.defaultBackend) %}
    default_backend {{backend_data.name}}
{%       endif %}
{%       if frontend.forwardFor == '1' %}
    option forwardfor
{%       endif %}
    # tuning options
{%       if frontend.tuning_maxConnections is defined %}
    maxconn {{frontend.tuning_maxConnections}}
{%       endif %}
{%       if frontend.tuning_timeoutClient is defined %}
    timeout client {{frontend.tuning_timeoutClient}}
{%       elif OPNsense.HAProxy.general.defaults.timeoutClient is defined %}
    timeout client {{OPNsense.HAProxy.general.defaults.timeoutClient}}
{%       endif %}
    # logging options
{%       if frontend.logging_dontLogNull=='1' %}
    option dontlognull
{%       endif %}
{%       if frontend.logging_dontLogNormal=='1' %}
    option dontlog-normal
{%       endif %}
{%       if frontend.logging_logSeparateErrors=='1' %}
    option log-separate-errors
{%       endif %}
{%       if frontend.logging_detailedLog=='1' %}
{#         # automatically select the best-suited log type #}
{%         if frontend.mode == 'tcp' %}
    option tcplog
{%         else %}
    option httplog
{%         endif %}
{%       endif %}
{%       if frontend.logging_socketStats=='1' %}
    option socket-stats
{%       endif %}
{#       # action and ACL configuration #}
{%       if frontend.linkedActions|default("") != "" -%}
{#         # call macro to evaluate ACLs and actions #}
{{         AclsAndActions(frontend.linkedActions) }}
{%-      endif %}
{#       # error files #}
{%       if frontend.linkedErrorfiles|default("") != "" %}
{#         # call macro to evaluate error files #}
{{         ErrorFiles(frontend.linkedErrorfiles) }}
{%       endif %}
{%       if frontend.customOptions|default("") != "" %}
    # WARNING: pass through options below this line
{%         for customOpt in frontend.customOptions.split("\n") %}
    {{customOpt}}
{%         endfor %}
{%       endif %}

{%     else %}
# Frontend (DISABLED): {{frontend.name}} ({{frontend.description}})

{%     endif %}
{%   endfor %}
{% endif %}

{# ############################### #}
{#             BACKENDS            #}
{# ############################### #}

{% if helpers.exists('OPNsense.HAProxy.backends') %}
{%   for backend in helpers.toList('OPNsense.HAProxy.backends.backend') %}
{#     # ignore disabled backends and those without a server #}
{%     if backend.enabled == '1' and backend.linkedServers|default("") != "" %}
# Backend: {{backend.name}} ({{backend.description}})
backend {{backend.name}}
{#       # store additional parameters for the "server" entries #}
{%       set healthcheck_additions = [] %}
{%       if backend.healthCheck|default("") != "" and backend.healthCheckEnabled == '1' %}
{%         set healthcheck_enabled = '1' %}
{%         if backend.healthCheckLogStatus == '1' %}
    option log-health-checks
{%         endif %}
{%         set healthcheck_data = helpers.getUUID(backend.healthCheck) %}
    # health check: {{healthcheck_data.name}}
{#         # health check option #}
{%         set healthcheck_options = [] %}
{%         if healthcheck_data.type|default("") == "" %}
{%           set healthcheck_enabled = '0' %}
{%         elif healthcheck_data.type == 'tcp' %}
{#           # custom TCP health check option #}
{%           if healthcheck_data.tcp_enabled|default("") == '1' %}
{#             # validate options: both must not be disabled at the same time #}
{%             if healthcheck_data.tcp_sendValue|default("") == "" and healthcheck_data.tcp_matchValue|default("") == "" %}
    # ERROR: invalid custom TCP health check, missing "sendValue" or "matchValue"
{%             else %}
{%               set healthcheck_customtcp = [] %}
{%               do healthcheck_customtcp.append('send ' ~ healthcheck_data.tcp_sendValue) if healthcheck_data.tcp_sendValue|default("") != "" %}
{%               if healthcheck_data.tcp_matchValue|default("") != "" %}
{%                 do healthcheck_customtcp.append('expect ' ~ healthcheck_data.tcp_matchType) %}
{%                 if healthcheck_data.tcp_negate == '1' and healthcheck_data.tcp_matchType|default("") != 'binary' %}
{%                   do healthcheck_customtcp.append('!') %}
{%                 endif %}
{%                 do healthcheck_customtcp.append(healthcheck_data.tcp_matchValue) %}
{%               endif %}
{#               # XXX: some values (send/match) must be properly escaped (whitespace) #}
{#               # TODO: add support for multiple send/expect steps #}
    option tcp-check
    tcp-check connect
    tcp-check {{healthcheck_customtcp|join(' ')}}
{%             endif %}
{%           endif %}
{%         elif healthcheck_data.type == 'http' %}
{%           do healthcheck_options.append('httpchk') %}
{#           # HTTP method must be uppercase #}
{%           do healthcheck_options.append(healthcheck_data.http_method|upper) %}
{%           do healthcheck_options.append(healthcheck_data.http_uri) %}
{%           do healthcheck_options.append('HTTP/1.0') if healthcheck_data.http_version == 'http10' %}
{#           # HTTP Host header requires HTTP 1.1 #}
{%           do healthcheck_options.append('HTTP/1.1') if healthcheck_data.http_version == 'http11' and healthcheck_data.http_host|default("") == "" %}
{%           do healthcheck_options.append('HTTP/1.1\\r\\nHost:\ ' ~ healthcheck_data.http_host) if healthcheck_data.http_version == 'http11' and healthcheck_data.http_host|default("") != "" %}
    option {{healthcheck_options|join(' ')}}
{#           # custom HTTP health check option #}
{%           if healthcheck_data.http_expressionEnabled|default("") == '1' %}
{#             # validate options #}
{%             if healthcheck_data.http_expression|default("") == "" or healthcheck_data.http_value|default("") == "" %}
    # ERROR: invalid custom HTTP health check, missing "expression" or "value"
{%             else %}
{%               set healthcheck_customhttp = [] %}
{%               do healthcheck_customhttp.append(healthcheck_data.http_expression) %}
{%               do healthcheck_customhttp.append('!') if healthcheck_data.http_negate == '1' %}
{#               # XXX: some values must be properly escaped (whitespace) #}
{%               do healthcheck_customhttp.append(healthcheck_data.http_value) %}
    http-check expect {{healthcheck_customhttp|join(' ')}}
{%             endif %}
{%           endif %}
{%         elif healthcheck_data.type == 'agent' %}
{%           if healthcheck_data.agent_port|default("") != "" %}
{%             do healthcheck_additions.append('agent-check agent-port ' ~ healthcheck_data.agent_port) %}
{%           else %}
    # ERROR: agent-check configured, but agent-port was not specified
{%           endif %}
{%         elif healthcheck_data.type == 'ldap' %}
    option ldap-check
{%         elif healthcheck_data.type == 'mysql'  %}
{%           if healthcheck_data.mysql_user|default("") != "" %}
{%             if healthcheck_data.mysql_post41|default("") == '1' %}
    option mysql-check user {{healthcheck_data.mysql_user}} post-41
{%             else %}
    option mysql-check user {{healthcheck_data.mysql_user}}
{%             endif %}
{%           else %}
    # ERROR: {{healthcheck_data.type}} check configured, but db user was not specified
{%           endif %}
{%         elif healthcheck_data.type == 'pgsql' %}
{%           if healthcheck_data.pgsql_user|default("") != "" %}
    option pgsql-check user {{healthcheck_data.pgsql_user}}
{%           else %}
    # ERROR: {{healthcheck_data.type}} check configured, but db user was not specified
{%           endif %}
{%         elif healthcheck_data.type == 'redis' %}
    option redis-check
{%         elif healthcheck_data.type == 'smtp' %}
    option smtpchk HELO {{healthcheck_data.smtp_domain}}
{%         elif healthcheck_data.type == 'esmtp' %}
    option smtpchk EHLO {{healthcheck_data.esmtp_domain}}
{%         elif healthcheck_data.type == 'ssl' %}
    option ssl-hello-chk
{%         endif %}
{%       else %}
    # health checking is DISABLED
{%         set healthcheck_enabled = '0' %}
{%       endif %}
{#       # XXX: Usually the frontend and the backend are in the same mode,  #}
{#       #      but we have no way to know what frontend uses this backend. #}
{#       #      Hence we can't automatically set the mode and thus need a   #}
{#       #      (redundant) GUI option for this.                            #}
    mode {{backend.mode}}
    balance {{backend.algorithm}}
{#       # ignore if stickiness is disabled (set to "None") #}
{%       if backend.stickiness_pattern|default("") != "" %}
    # stickiness
{%         if backend.stickiness_pattern == "sourceipv4" %}
    stick-table type ip size {{backend.stickiness_size}} expire {{backend.stickiness_expire}}
    stick on src
{%         elif backend.stickiness_pattern == "sourceipv6" %}
    stick-table type ipv6 size {{backend.stickiness_size}} expire {{backend.stickiness_expire}}
    stick on src
{%         elif backend.stickiness_pattern == "cookievalue" %}
    stick-table type string len {{backend.stickiness_cookielength}} size {{backend.stickiness_size}} expire {{backend.stickiness_expire}}
    stick store-response res.cook({{backend.stickiness_cookiename}})
    stick on req.cook({{backend.stickiness_cookiename}})
{%         elif backend.stickiness_pattern == "rdpcookie" %}
    stick-table type binary len {{backend.stickiness_cookielength}} size {{backend.stickiness_size}} expire {{backend.stickiness_expire}}
    stick on req.rdp_cookie(mstshash)
{%         endif %}
{%       endif %}
    # tuning options
{%       if backend.tuning_timeoutConnect|default("") != "" %}
    timeout connect {{backend.tuning_timeoutConnect}}
{%       elif OPNsense.HAProxy.general.defaults.timeoutConnect is defined %}
    timeout connect {{OPNsense.HAProxy.general.defaults.timeoutConnect}}
{%       endif %}
{%       if backend.tuning_timeoutCheck|default("") != "" %}
    timeout check {{backend.tuning_timeoutCheck}}
{%       elif OPNsense.HAProxy.general.defaults.timeoutCheck is defined %}
    timeout check {{OPNsense.HAProxy.general.defaults.timeoutCheck}}
{%       endif %}
{%       if backend.tuning_timeoutServer|default("") != "" %}
    timeout server {{backend.tuning_timeoutServer}}
{%       elif OPNsense.HAProxy.general.defaults.timeoutServer is defined %}
    timeout server {{OPNsense.HAProxy.general.defaults.timeoutServer}}
{%       endif %}
{%       if backend.tuning_retries|default("") != "" %}
    retries {{backend.tuning_retries}}
{%       endif %}
{#       # action and ACL configuration #}
{%       if backend.linkedActions|default("") != "" -%}
{#         # call macro to evaluate ACLs and actions #}
{{         AclsAndActions(backend.linkedActions) }}
{%-      endif %}
{#       # error files #}
{%       if backend.linkedErrorfiles|default("") != "" %}
{#         # call macro to evaluate error files #}
{{         ErrorFiles(backend.linkedErrorfiles) }}
{%       endif %}
{%       if backend.customOptions|default("") != "" %}
    # WARNING: pass through options below this line
{%         for customOpt in backend.customOptions.split("\n") %}
    {{customOpt}}
{%         endfor %}
{%       endif %}
{%       if backend.tuning_defaultserver|default("") != "" %}
    default-server {{backend.tuning_defaultserver}}
{%       endif %}
{%       for server in backend.linkedServers.split(",") %}
{%         set server_data = helpers.getUUID(server) %}
{#         # check if this server can be found in configuration #}
{%         if server_data == {} %}
# ERROR: server data not found ({{server}})
{%         else %}
{#           # collect optional server parameters #}
{%           set server_options = [] %}
{#           # check if health check is enabled #}
{%           if healthcheck_enabled == '1' %}
{%             do server_options.append('check') %}
{#             # server settings take precedence over healthcheck settings #}
{%             if server_data.checkInterval|default("") != "" %}
{%               do server_options.append('inter ' ~ server_data.checkInterval) %}
{%             elif healthcheck_data.interval|default("") != "" %}
{%               do server_options.append('inter ' ~ healthcheck_data.interval) %}
{%             endif %}
{#             # use a different interval when server is in DOWN state #}
{%             if server_data.checkDownInterval|default("") != "" %}
{%               do server_options.append('downinter ' ~ server_data.checkDownInterval) %}
{%             endif %}
{#             # use a different port for health check #}
{%             if healthcheck_data.checkport|default("") != "" %}
{#               # prefer port from health check template #}
{%               do server_options.append('port ' ~ healthcheck_data.checkport) %}
{%             elif server_data.checkport|default("") != "" %}
{%               do server_options.append('port ' ~ server_data.checkport) %}
{%             endif %}
{#             # add all additions from healthchecks here #}
{%             do server_options.append(healthcheck_additions|join(' ')) if healthcheck_additions.length != '0' %}
{%           endif %}
{#           # server weight #}
{%           do server_options.append('weight ' ~ server_data.weight) if server_data.weight|default("") != "" %}
{#           # server role/mode #}
{%           if server_data.mode|default("") != 'active' %}
{%             do server_options.append(server_data.mode) %}
{%           endif %}
{#           # server ssl communication #}
{%           if server_data.ssl|default("") == '1' %}
{%             do server_options.append('ssl') %}
{#             # get status of ssl verification #}
{%             set ssl_verify_enabled = '0' %}
{%             if helpers.exists('OPNsense.HAProxy.general.tuning.sslServerVerify') and OPNsense.HAProxy.general.tuning.sslServerVerify|default("") != 'ignore' %}
{#               # NOTE: Global parameter overrides per-server configuration. #}
{%               set ssl_verify_enabled = '1' if OPNsense.HAProxy.general.tuning.sslServerVerify|default("") == 'required' %}
{%             elif server_data.sslVerify|default("") == '1' %}
{%               set ssl_verify_enabled = '1' %}
{%             endif %}
{#             # configure ssl verification #}
{%             if ssl_verify_enabled == '1' %}
{#               # enable SSL verification #}
{%               do server_options.append('verify required') %}
{#               # check for SSL CA #}
{%               if server_data.sslCA|default("") != "" %}
{%                 do server_options.append('ca-file /var/etc/haproxy/ssl/' ~ server_data.sslCA ~ '.pem') %}
{%               endif %}
{#               # check for SSL CRL #}
{%               if server_data.sslCRL|default("") != "" %}
{%                 do server_options.append('crl-file /var/etc/haproxy/ssl/' ~ server_data.sslCRL ~ '.pem') %}
{%               endif %}
{#               # check for SSL client cert #}
{%               if server_data.sslClientCertificate|default("") != "" %}
{%                 do server_options.append('crt /var/etc/haproxy/ssl/' ~ server_data.sslClientCertificate ~ '.pem') %}
{%               endif %}
{%             else %}
{%               do server_options.append('verify none') %}
{%             endif %}
{%           endif %}
{#           # source address #}
{%           if backend.source|default("") != "" %}
{#             # prefer backend configuration #}
{%             do server_options.append('source ' ~ backend.source) %}
{%           elif server_data.source|default("") != "" %}
{%             do server_options.append('source ' ~ server_data.source) %}
{%           endif %}
{#           # server advanced options #}
{%           if server_data.advanced|default("") != "" %}
{%             do server_options.append(server_data.advanced) %}
{%           endif %}
    server {{server_data.name}} {{server_data.address}}:{% if backend.tuning_noport != '1' %}{% if server_data.port|default("") != "" %}{{server_data.port}}{% endif %}{% endif %} {{server_options|join(' ')}}
{%         endif %}
{%       endfor %}

{%     else %}
# Backend (DISABLED): {{backend.name}} ({{backend.description}})

{%     endif %}
{%   endfor %}
{% endif %}

{# ############################### #}
{#             STATISTICS          #}
{# ############################### #}

{% if helpers.exists('OPNsense.HAProxy.general.stats') and OPNsense.HAProxy.general.stats.enabled|default("") == "1" %}
{# # enable local stats #}
listen local_statistics
    bind            127.0.0.1:{{OPNsense.HAProxy.general.stats.port}}
    mode            http
    stats uri       /haproxy?stats
    stats realm     HAProxy\ statistics
    stats admin     if TRUE
{%   if OPNsense.HAProxy.general.stats.customOptions|default("") != "" %}
    # WARNING: pass through options below this line
{%     for customOpt in OPNsense.HAProxy.general.stats.customOptions.split("\n") %}
    {{customOpt}}
{%     endfor %}
{%   endif %}

{# # remote stats are optional #}
{%   if OPNsense.HAProxy.general.stats.remoteEnabled|default("") == "1" %}
{%     if OPNsense.HAProxy.general.stats.remoteBind|default("") != "" %}
listen  remote_statistics
{%       for bind in OPNsense.HAProxy.general.stats.remoteBind.split(",") %}
    bind            {{bind}}
{%       endfor %}
    mode            http
    stats uri       /haproxy?stats
    stats realm     HAProxy\ statistics
    stats hide-version
{#       # enable authentication? #}
{%       if OPNsense.HAProxy.general.stats.authEnabled|default("") == "1" %}
{%         if OPNsense.HAProxy.general.stats.users|default("") != "" %}
{%           for statsuser in OPNsense.HAProxy.general.stats.users.split(",") %}
    stats auth      {{statsuser}}
{%           endfor %}
{%         endif %}
{%       endif %}
{%       if OPNsense.HAProxy.general.stats.customOptions|default("") != "" %}
    # WARNING: pass through options below this line
{%         for customOpt in OPNsense.HAProxy.general.stats.customOptions.split("\n") %}
    {{customOpt}}
{%         endfor %}
{%       endif %}
{%     else %}
# ERROR: remote statistics disabled, because no listen address was specified
{%     endif %}
{%   endif %}
{% else %}
# statistics are DISABLED
{% endif %}

{% endif %}
