{% if helpers.exists('OPNsense.chrony.general.enabled') and OPNsense.chrony.general.enabled == '1' %}

port {{ OPNsense.chrony.general.port }}
{%  if not helpers.empty('OPNsense.chrony.general.allowednetworks') %}
{%      for network in OPNsense.chrony.general.allowednetworks.split(',') %}
allow {{ network }}
{%      endfor %}
{%  endif %}

{%  if not helpers.empty('OPNsense.chrony.general.peers') %}
{%      set peers = OPNsense.chrony.general.peers.peer %}
{%      if peers is mapping %}
{%          set peers = [peers] %}
{%      endif %}
{%      for peer in peers %}
{% if peer.pool == '1' %}pool   {% else %}server {% endif %}{{peer.address}}{% if peer.prefer == '1' %} prefer{% endif %}{% if peer.iburst == '1' %} iburst{% endif %}{% if peer.xleave == '1' %} xleave{% endif %}{% if peer.minpoll is defined and peer.minpoll != '' %} minpoll {{ peer.minpoll }}{% endif %}{% if peer.maxpoll is defined and peer.maxpoll != '' %} maxpoll {{ peer.maxpoll }}{% endif %}

{%      endfor %}
{%  endif %}

{%  if helpers.exists('OPNsense.chrony.general.fallbackpeers') and OPNsense.chrony.general.fallbackpeers != '' %}
authselectmode mix
server {{ OPNsense.chrony.general.fallbackpeers }}
{%  endif %}

{%  if not helpers.empty('OPNsense.chrony.general.localstratum') %}
local stratum {{ OPNsense.chrony.general.localstratum }} {% if helpers.exists('OPNsense.chrony.general.orphanmode') and OPNsense.chrony.general.orphanmode == '1' %}orphan{% endif %}

{%  endif %}
driftfile /var/db/chrony/drift
pidfile /var/run/chrony/chronyd.pid
makestep 1 3

{%  if helpers.exists('OPNsense.chrony.general.ntsclient') and OPNsense.chrony.general.ntsclient == '1' %}
ntsdumpdir /var/lib/chrony
ntstrustedcerts /usr/local/etc/ssl/cert.pem
nosystemcert
{%  endif %}

{%  if helpers.exists('OPNsense.chrony.general.ntsnocert') and OPNsense.chrony.general.ntsnocert == '1' %}
nocerttimecheck 1
{%  endif %}

{% endif %}
